@page "/admin/home"
@rendermode InteractiveServer
@layout Layout.AdminLayout
@inject AppDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Admin Home</PageTitle>

<div class="home-container">
    <div class="quote-box">
        <h2>@quote</h2>
    </div>

    <div class="sales-grid">
        <div class="sales-card">
            <h3>Daily Sales</h3>
            <p>â‚±@dailySales.ToString("N2")</p>
        </div>
        <div class="sales-card">
            <h3>Weekly Sales</h3>
            <p>â‚±@weeklySales.ToString("N2")</p>
        </div>
        <div class="sales-card">
            <h3>Monthly Sales</h3>
            <p>â‚±@monthlySales.ToString("N2")</p>
        </div>
        <div class="sales-card">
            <h3>Yearly Sales</h3>
            <p>â‚±@yearlySales.ToString("N2")</p>
        </div>
    </div>

    <div class="chart-section">
        <h3>ðŸ“ˆ Sales Growth Overview</h3>
        <canvas id="salesChart" width="600" height="300"></canvas>
    </div>
</div>

@code {
    private string quote = string.Empty;
    private decimal dailySales = 0;
    private decimal weeklySales = 0;
    private decimal monthlySales = 0;
    private decimal yearlySales = 0;
    private List<SalesData> chartData = new();

    private readonly string[] quotes =
    {
        "Every drop counts â€” keep pushing forward!",
        "Success flows like water â€” steady and unstoppable.",
        "Stay consistent, even when progress feels slow.",
        "Hard work beats talent when talent doesn't work hard.",
        "Be patient. Great results take time and persistence.",
        "Each small effort adds up to something big.",
        "You are not tired, you are just one step away from greatness."
    };

    protected override async Task OnInitializedAsync()
    {
        var rand = new Random();
        quote = quotes[rand.Next(quotes.Length)];

        await LoadSalesData();
    }

    private async Task LoadSalesData()
    {
        var now = DateTime.UtcNow;
        var today = now.Date;
        var startOfWeek = today.AddDays(-(int)today.DayOfWeek);
        var startOfMonth = new DateTime(today.Year, today.Month, 1);
        var startOfYear = new DateTime(today.Year, 1, 1);

        // Get all completed orders (orders that have been delivered or have completed status)
        var completedOrders = await DbContext.Orders
            .AsNoTracking()
            .Where(o => o.TimeDelivered.HasValue || 
                       o.Status == "Completed" || 
                       o.Status == "Delivered" ||
                       (o.PaymentStatus == "Paid" && o.DeliveryStatus == "Delivered"))
            .ToListAsync();

        // Calculate daily sales (today)
        dailySales = completedOrders
            .Where(o => o.CreatedAt.Date == today)
            .Sum(o => o.TotalPrice);

        // Calculate weekly sales (this week)
        weeklySales = completedOrders
            .Where(o => o.CreatedAt.Date >= startOfWeek)
            .Sum(o => o.TotalPrice);

        // Calculate monthly sales (this month)
        monthlySales = completedOrders
            .Where(o => o.CreatedAt.Date >= startOfMonth)
            .Sum(o => o.TotalPrice);

        // Calculate yearly sales (this year)
        yearlySales = completedOrders
            .Where(o => o.CreatedAt.Date >= startOfYear)
            .Sum(o => o.TotalPrice);

        // Prepare chart data - last 7 days
        var last7Days = Enumerable.Range(0, 7)
            .Select(i => today.AddDays(-i))
            .Reverse()
            .ToList();

        chartData = last7Days.Select(date =>
        {
            var sales = completedOrders
                .Where(o => o.CreatedAt.Date == date)
                .Sum(o => o.TotalPrice);
            
            return new SalesData
            {
                Date = date,
                Sales = sales
            };
        }).ToList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("renderSalesChart", chartData.Select(d => d.Sales).ToArray());
        }
    }

    private class SalesData
    {
        public DateTime Date { get; set; }
        public decimal Sales { get; set; }
    }
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.renderSalesChart = (salesData) => {
        const ctx = document.getElementById('salesChart');
        if (!ctx) return;

        // Default data if none provided
        const data = salesData && salesData.length > 0 
            ? salesData 
            : [0, 0, 0, 0, 0, 0, 0];

        // Get last 7 days labels
        const today = new Date();
        const labels = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            labels.push(dayNames[date.getDay()]);
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sales (â‚±)',
                    data: data,
                    backgroundColor: 'rgba(0, 123, 255, 0.3)',
                    borderColor: '#007bff',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: '#00bfff',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { 
                        display: false 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'â‚±' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        ticks: { color: '#004c91' },
                        grid: { color: 'rgba(0, 76, 145, 0.1)' }
                    },
                    y: { 
                        ticks: { 
                            color: '#004c91',
                            callback: function(value) {
                                return 'â‚±' + value.toFixed(0);
                            }
                        },
                        grid: { color: 'rgba(0, 76, 145, 0.1)' }
                    }
                }
            }
        });
    };
</script>

<style>
.home-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    color: #fff;
    width: 100%;
    height: 100%;
    margin: 0;
    overflow-y: auto;
}

.quote-box {
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(3px);
    padding: 1rem 2rem;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    color: #004c91;
    width: 90%;
    max-width: 1000px;
}

.quote-box h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.sales-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.2rem;
    width: 90%;
    max-width: 1000px;
    margin-bottom: 3rem;
}

.sales-card {
    background: rgba(255, 255, 255, 0.85);
    color: #004c91;
    border-radius: 12px;
    padding: 1.2rem;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    transition: transform 0.2s ease;
    margin: 0;
}

.sales-card:hover { 
    transform: scale(1.05); 
}

.sales-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: #666;
}

.sales-card p {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    color: #004c91;
}

.chart-section {
    background: rgba(255, 255, 255, 0.85);
    color: #004c91;
    padding: 1.5rem;
    border-radius: 12px;
    width: 90%;
    max-width: 1000px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    margin-bottom: 2rem;
}

.chart-section h3 {
    text-align: center;
    margin-bottom: 1rem;
    font-size: 1.3rem;
    font-weight: 700;
}

#salesChart {
    max-height: 300px;
}

@@media (max-width: 768px) {
    .home-container {
        padding: 1rem;
    }

    .quote-box {
        padding: 0.8rem 1.5rem;
    }

    .quote-box h2 {
        font-size: 1.2rem;
    }

    .sales-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .sales-card {
        padding: 1rem;
    }

    .sales-card p {
        font-size: 1.4rem;
    }

    .chart-section {
        padding: 1rem;
    }
}

@@media (max-width: 480px) {
    .sales-grid {
        grid-template-columns: 1fr;
    }
}
</style>